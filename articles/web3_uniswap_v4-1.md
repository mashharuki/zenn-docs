---
title: "UniswapV4ã«å¯¾å¿œã—ãŸã‚ªãƒªã‚¸ãƒŠãƒ«Hookã‚’ä½œã£ã¦ã¿ã‚ˆã†ï¼"
emoji: "ğŸ¦„"
type: "tech"
topics: ["Web3","blockchain","DEX","solidity","Ethereum"]
published: false
---

# ã¯ã˜ã‚ã«

å…ˆæ—¥ **ETH Global**ãŒä¸»å‚¬ã™ã‚‹**HackMoney2026**ã«å‚åŠ ã™ã‚‹æ©Ÿä¼šãŒã‚ã‚Š**UniswapV4**ã‚’ä½¿ã£ãŸHookã‚’é–‹ç™ºã™ã‚‹æ©Ÿä¼šãŒã‚ã‚Šã¾ã—ãŸã€‚

https://ethglobal.com/events/hackmoney2026

èª¿ã¹ã‚‹ä¸­ã§è‰²ã€…ã¨åˆ†ã‹ã£ãŸã“ã¨ãŒã‚ã‚‹ã®ã§å­¦ã³ã‚’ã‚·ã‚§ã‚¢ã™ã‚‹ãŸã‚ã«è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã€‚

ãœã²æœ€å¾Œã¾ã§èª­ã‚“ã§ã„ã£ã¦ãã ã•ã„ï¼

# Uniswapã¨ã¯

**Uniswap** ã¯ã€Ethereum ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ä¸Šã«æ§‹ç¯‰ã•ã‚ŒãŸ **åˆ†æ•£å‹å–å¼•æ‰€ï¼ˆDEXï¼‰** ã§ã™ã€‚2018å¹´ã« **Hayden Adams** æ°ã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚Œã€ç¾åœ¨ã§ã¯ DeFiï¼ˆåˆ†æ•£å‹é‡‘èï¼‰ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã®ä¸­æ ¸ã‚’æ‹…ã†å­˜åœ¨ã¨ãªã£ã¦ã„ã¾ã™ï¼

https://app.uniswap.org/

æ•°ã‚ã‚‹Web3ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ä¸­ã§ã‚‚æœ€ã‚‚æˆåŠŸã—ãŸã‚‚ã®ã®ä¸€ã¤ã¨ã—ã¦å›è‡¨ã—ç¶šã‘ã¦ã„ã¾ã™ã€‚

Uniswap ã®æœ€å¤§ã®ç‰¹å¾´ã¯ã€**AMMï¼ˆAutomated Market Maker / è‡ªå‹•ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼ï¼‰** ã¨ã„ã†ä»•çµ„ã¿ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ç‚¹ã§ã™ã€‚

å¾“æ¥ã®å–å¼•æ‰€ã®ã‚ˆã†ã«ã€Œè²·ã„æ‰‹ã€ã¨ã€Œå£²ã‚Šæ‰‹ã€ãŒç›´æ¥ãƒãƒƒãƒãƒ³ã‚°ã™ã‚‹ã‚ªãƒ¼ãƒ€ãƒ¼ãƒ–ãƒƒã‚¯æ–¹å¼ã§ã¯ãªãã€**æµå‹•æ€§ãƒ—ãƒ¼ãƒ«** ã¨å‘¼ã°ã‚Œã‚‹ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é ã‘ã‚‹ã“ã¨ã§ã€èª°ã§ã‚‚ãƒˆãƒ¼ã‚¯ãƒ³ã®äº¤æ›ï¼ˆã‚¹ãƒ¯ãƒƒãƒ—ï¼‰ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

## Uniswapã®æ­´å²

Uniswap ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«é€²åŒ–ã‚’é‚ã’ã¦ãã¾ã—ãŸã€‚

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ãƒªãƒªãƒ¼ã‚¹å¹´ | ä¸»ãªç‰¹å¾´ |
|-----------|-----------|---------|
| **V1** | 2018å¹´ | ETHâ‡”ERC-20ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒšã‚¢ã®ã¿ã€‚AMM ã®åŸºæœ¬æ¦‚å¿µã‚’å®Ÿè¨¼ |
| **V2** | 2020å¹´ | ERC-20â‡”ERC-20 ã®ç›´æ¥ãƒšã‚¢ã«å¯¾å¿œã€‚ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ãƒ¯ãƒƒãƒ—å°å…¥ |
| **V3** | 2021å¹´ | **é›†ä¸­æµå‹•æ€§ï¼ˆConcentrated Liquidityï¼‰** ã‚’å°å…¥ã€‚è³‡æœ¬åŠ¹ç‡ãŒé£›èºçš„ã«å‘ä¸Š |
| **V4** | 2025å¹´ | **Hooks**ã€**ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³è¨­è¨ˆ**ã€**Flash Accounting** ç­‰ã§æŸ”è»Ÿæ€§ã¨ã‚¬ã‚¹åŠ¹ç‡ã‚’å¤§å¹…æ”¹å–„ |

## AMMã®ä»•çµ„ã¿

Uniswap ã® AMM ã¯ **å®šç©å…¬å¼ï¼ˆConstant Product Formulaï¼‰** ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚

$$x \times y = k$$

- $x$ = ãƒ—ãƒ¼ãƒ«å†…ã®ãƒˆãƒ¼ã‚¯ãƒ³Aã®é‡
- $y$ = ãƒ—ãƒ¼ãƒ«å†…ã®ãƒˆãƒ¼ã‚¯ãƒ³Bã®é‡  
- $k$ = å®šæ•°ï¼ˆæµå‹•æ€§è¿½åŠ /å‰Šé™¤æ™‚ä»¥å¤–ã¯å¤‰ã‚ã‚‰ãªã„ï¼‰

ä¾‹ãˆã°ã€ãƒ—ãƒ¼ãƒ«ã« 10 ETH ã¨ 30,000 USDC ãŒã‚ã‚‹å ´åˆã€$k = 10 \times 30{,}000 = 300{,}000$ ã§ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ 1 ETH ã‚’æŠ•å…¥ã™ã‚‹ã¨ã€ãƒ—ãƒ¼ãƒ«ã¯ $k$ ãŒä¸€å®šã«ãªã‚‹ã‚ˆã†ã« USDC ã‚’æ‰•ã„å‡ºã—ã¾ã™ã€‚

$$11 \times y = 300{,}000 \quad \Rightarrow \quad y \approx 27{,}273$$

ã¤ã¾ã‚Šã€ç´„ 2,727 USDC ã‚’å—ã‘å–ã‚Œã‚‹è¨ˆç®—ã§ã™ï¼ˆå®Ÿéš›ã«ã¯æ‰‹æ•°æ–™ã‚‚ç™ºç”Ÿã—ã¾ã™ï¼‰ã€‚

## æµå‹•æ€§ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆLPï¼‰

Uniswap ã§ã¯ã€èª°ã§ã‚‚ **æµå‹•æ€§ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆLPï¼‰** ã¨ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ãƒšã‚¢ã‚’ãƒ—ãƒ¼ãƒ«ã«é ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚LP ã¯å–å¼•æ‰‹æ•°æ–™ã®ä¸€éƒ¨ã‚’å ±é…¬ã¨ã—ã¦å—ã‘å–ã‚Šã¾ã™ã€‚

:::message
**åˆå¿ƒè€…å‘ã‘ãƒã‚¤ãƒ³ãƒˆ**: 

æµå‹•æ€§ã‚’æä¾›ã™ã‚‹ã¨ã‚¹ãƒ¯ãƒƒãƒ—æ‰‹æ•°æ–™ãŒå¾—ã‚‰ã‚Œã¾ã™ãŒã€**ã‚¤ãƒ³ãƒ‘ãƒ¼ãƒãƒãƒ³ãƒˆãƒ­ã‚¹ï¼ˆå¤‰å‹•æå¤±ï¼‰** ã¨ã„ã†ãƒªã‚¹ã‚¯ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯é ã‘ãŸãƒˆãƒ¼ã‚¯ãƒ³ã®ä¾¡æ ¼æ¯”ç‡ãŒå¤‰å‹•ã—ãŸå ´åˆã«ç™ºç”Ÿã™ã‚‹ä¸€æ™‚çš„ãªæå¤±ã§ã™ã€‚
:::

# DEXã¨ã¯

## DEXï¼ˆåˆ†æ•£å‹å–å¼•æ‰€ï¼‰ã®åŸºæœ¬

**DEXï¼ˆDecentralized Exchangeï¼‰** ã¨ã¯ã€ä¸­å¤®ç®¡ç†è€…ã‚’æŒãŸãªã„ã€ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ä¸Šã®ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«ã‚ˆã£ã¦é‹å–¶ã•ã‚Œã‚‹å–å¼•æ‰€ã§ã™ã€‚

## CEX vs DEX ã®æ¯”è¼ƒ

| è¦³ç‚¹ | CEXï¼ˆä¸­å¤®é›†æ¨©å‹å–å¼•æ‰€ï¼‰ | DEXï¼ˆåˆ†æ•£å‹å–å¼•æ‰€ï¼‰ |
|------|----------------------|-------------------|
| **ç®¡ç†è€…** | ä¼æ¥­ãŒé‹å–¶ | ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒè‡ªå‹•é‹å–¶ |
| **è³‡ç”£ã®ç®¡ç†** | å–å¼•æ‰€ãŒä¿ç®¡ï¼ˆã‚«ã‚¹ãƒˆãƒ‡ã‚£ã‚¢ãƒ«ï¼‰ | ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ãŒç®¡ç†ï¼ˆãƒãƒ³ã‚«ã‚¹ãƒˆãƒ‡ã‚£ã‚¢ãƒ«ï¼‰ |
| **KYC/æœ¬äººç¢ºèª** | å¿…é ˆ | ä¸è¦ï¼ˆã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šã®ã¿ï¼‰ |
| **å–å¼•é€Ÿåº¦** | é«˜é€Ÿ | ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã®é€Ÿåº¦ã«ä¾å­˜ |
| **ä¸Šå ´ãƒ—ãƒ­ã‚»ã‚¹** | å–å¼•æ‰€ã®å¯©æŸ»ãŒå¿…è¦ | **ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ¬ã‚¹**ï¼ˆèª°ã§ã‚‚ãƒ—ãƒ¼ãƒ«ä½œæˆå¯èƒ½ï¼‰ |
| **é€æ˜æ€§** | å†…éƒ¨ãƒ­ã‚¸ãƒƒã‚¯ã¯éå…¬é–‹ | ã‚³ãƒ¼ãƒ‰ãŒã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ |
| **ãƒªã‚¹ã‚¯** | ãƒãƒƒã‚­ãƒ³ã‚°ã€å–å¼•æ‰€ã®ç ´ç¶» | ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®è„†å¼±æ€§ |
| **ä»£è¡¨ä¾‹** | Binance, Coinbase | Uniswap, SushiSwap, Curve |

## DEXã®ä¸»ãªç¨®é¡

### 1. AMMå‹ï¼ˆè‡ªå‹•ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼ï¼‰

æµå‹•æ€§ãƒ—ãƒ¼ãƒ«ã¨ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ä¾¡æ ¼ã‚’æ±ºå®šã™ã‚‹æ–¹å¼ã§ã™ã€‚Uniswapã€Curveã€Balancer ãŒã“ã®ã‚¿ã‚¤ãƒ—ã«è©²å½“ã—ã¾ã™ã€‚

### 2. ã‚ªãƒ¼ãƒ€ãƒ¼ãƒ–ãƒƒã‚¯å‹

å¾“æ¥ã®å–å¼•æ‰€ã¨åŒæ§˜ã«è²·ã„æ³¨æ–‡ã¨å£²ã‚Šæ³¨æ–‡ã‚’ãƒãƒƒãƒãƒ³ã‚°ã•ã›ã‚‹æ–¹å¼ã§ã™ã€‚dYdX ãªã©ãŒã“ã®ã‚¿ã‚¤ãƒ—ã§ã™ã€‚

### 3. ã‚¢ã‚°ãƒªã‚²ãƒ¼ã‚¿ãƒ¼å‹

è¤‡æ•°ã® DEX ã‹ã‚‰æœ€ã‚‚æœ‰åˆ©ãªãƒ¬ãƒ¼ãƒˆã‚’æ¢ã—ã¦å–å¼•ã‚’ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã¾ã™ã€‚1inch ã‚„ Paraswapã€LI.FIãŒè©²å½“ã—ã¾ã™ã€‚

https://1inch.com/ja

https://li.fi/

# UniswapV4ã§ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨

Uniswap V4 ã¯ 2025å¹´ã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸæœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã™ã€‚V3 ã®é›†ä¸­æµå‹•æ€§ã‚’ç¶™æ‰¿ã—ã¤ã¤ã€**Hooks** ã«ã‚ˆã‚‹æ‹¡å¼µæ€§ã¨ **ã‚¬ã‚¹æœ€é©åŒ–** ã‚’å®Ÿç¾ã—ãŸå¤§å‹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ã™ã€‚

https://docs.uniswap.org/contracts/v4/overview

V4ã®ä¸»è¦ãªæ–°æ©Ÿèƒ½ã‚’ä»¥ä¸‹ã®6ã¤ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§è§£èª¬ã—ã¾ã™ã€‚

## 1. Hooksï¼ˆãƒ•ãƒƒã‚¯ï¼‰ â€” æœ€å¤§ã®ç›®ç‰æ©Ÿèƒ½

**Hooks** ã¯ã€Uniswap V4 ã§å°å…¥ã•ã‚ŒãŸæœ€ã‚‚é©æ–°çš„ãªæ©Ÿèƒ½ã§ã™ã€‚ã“ã‚Œã¯æµå‹•æ€§ãƒ—ãƒ¼ãƒ«ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã§ãã‚‹**å¤–éƒ¨ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ**ã®ã“ã¨ã§ã™ã€‚

https://docs.uniswap.org/contracts/v4/concepts/hooks

### Hooksã®ä»•çµ„ã¿

- å„ãƒ—ãƒ¼ãƒ«ã«ã¯ **1ã¤ã®Hookã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ** ã‚’ã‚¢ã‚¿ãƒƒãƒå¯èƒ½ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- 1ã¤ã®Hookã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¯ **è¤‡æ•°ã®ãƒ—ãƒ¼ãƒ«** ã«ç´ä»˜ã‘å¯èƒ½
- ãƒ—ãƒ¼ãƒ«ä½œæˆæ™‚ï¼ˆ`PoolManager.initialize`ï¼‰ã«Hookã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®š

### Hooké–¢æ•°ã®ç¨®é¡

Hooks ã¯ã‚¹ãƒ¯ãƒƒãƒ—ã‚„æµå‹•æ€§æ“ä½œã® **å‰å¾Œ** ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚’å·®ã—è¾¼ã‚ã¾ã™ã€‚  
ã™ã¹ã¦ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ã¯ãªãã€å¿…è¦ãªã‚‚ã®ã ã‘ã‚’é¸ã‚“ã§ä½¿ãˆã¾ã™ã€‚

```bash
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Hook Functions                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ãƒ—ãƒ¼ãƒ«åˆæœŸåŒ–     â”‚ beforeInitialize / afterInitialize           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æµå‹•æ€§è¿½åŠ        â”‚ beforeAddLiquidity / afterAddLiquidity       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æµå‹•æ€§å‰Šé™¤       â”‚ beforeRemoveLiquidity / afterRemoveLiquidity â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã‚¹ãƒ¯ãƒƒãƒ—         â”‚ beforeSwap / afterSwap                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯„ä»˜ï¼ˆDonateï¼‰   â”‚ beforeDonate / afterDonate                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Hooksã§å®Ÿç¾ã§ãã‚‹ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

Hooks ã®å°å…¥ã«ã‚ˆã‚Šã€Uniswap V4 ä¸Šã§ä»¥ä¸‹ã®ã‚ˆã†ãªé«˜åº¦ãªDeFiãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’æ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

- **æŒ‡å€¤æ³¨æ–‡ï¼ˆLimit Ordersï¼‰**: ç‰¹å®šã®ä¾¡æ ¼ã«é”ã—ãŸã‚‰è‡ªå‹•çš„ã«ã‚¹ãƒ¯ãƒƒãƒ—ã‚’å®Ÿè¡Œ
- **ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ©ã‚¯ãƒ«**: ãƒ—ãƒ¼ãƒ«ç‹¬è‡ªã®ã‚ªãƒ©ã‚¯ãƒ«ã‚’å®Ÿè£…
- **ã‚«ã‚¹ã‚¿ãƒ AMMæ›²ç·š**: $x \times y = k$ ä»¥å¤–ã®ä¾¡æ ¼æ›²ç·šã‚’å®Ÿè£…å¯èƒ½
- **å‹•çš„æ‰‹æ•°æ–™**: å¸‚å ´çŠ¶æ³ã«å¿œã˜ã¦æ‰‹æ•°æ–™ã‚’è‡ªå‹•èª¿æ•´
- **è‡ªå‹•æµå‹•æ€§ç®¡ç†**: æ¡ä»¶ã«å¿œã˜ã¦æµå‹•æ€§ã‚’è‡ªå‹•ãƒªãƒãƒ©ãƒ³ã‚¹
- **ã‚¤ãƒ¼ãƒ«ãƒ‰ãƒ•ã‚¡ãƒ¼ãƒŸãƒ³ã‚°**: æµå‹•æ€§æä¾›ã«è¿½åŠ ã®ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–ã‚’ä»˜ä¸
- **ãƒ¬ãƒ³ãƒ‡ã‚£ãƒ³ã‚°é€£æº**: Uniswap V4 ã®ãƒ—ãƒ¼ãƒ«ã¨èåˆã—ãŸãƒ¬ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ—ãƒ­ãƒˆã‚³ãƒ«

:::message
**é–‹ç™ºè€…ã¸ã®ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ**: 

Hooks ã‚’ä½¿ãˆã°ã€ã¾ã£ãŸãæ–°ã—ã„DeFiãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚’ã‚¼ãƒ­ã‹ã‚‰ä½œã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚Uniswap V4 ã®å …ç‰¢ãªã‚¤ãƒ³ãƒ•ãƒ©ä¸Šã«ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¼‰ã›ã‚‹ã“ã¨ã§ã€**é–‹ç™ºã‚¹ãƒ”ãƒ¼ãƒ‰ã®å‘ä¸Š**ã¨**ç›£æŸ»ã‚³ã‚¹ãƒˆã®å‰Šæ¸›**ãŒæœŸå¾…ã§ãã¾ã™ã€‚
:::

## 2. ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³è¨­è¨ˆï¼ˆSingleton Designï¼‰

### V3ã®èª²é¡Œ

V3 ã§ã¯ã€ãƒ—ãƒ¼ãƒ«ã”ã¨ã« **å€‹åˆ¥ã®ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ** ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã¾ã—ãŸï¼ˆFactory ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ã€‚

ã“ã‚Œã«ã¯ä»¥ä¸‹ã®å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚

- ãƒ—ãƒ¼ãƒ«ä½œæˆæ™‚ã®ã‚¬ã‚¹ã‚³ã‚¹ãƒˆãŒé«˜ã„ï¼ˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ï¼‰
- ãƒãƒ«ãƒãƒ›ãƒƒãƒ—ã‚¹ãƒ¯ãƒƒãƒ—æ™‚ã«ãƒ—ãƒ¼ãƒ«é–“ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’éƒ½åº¦è»¢é€ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

### V4ã®è§£æ±ºç­–

V4 ã§ã¯ã€ã™ã¹ã¦ã®ãƒ—ãƒ¼ãƒ«ã®çŠ¶æ…‹ã¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’ **1ã¤ã® `PoolManager` ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ** ã«é›†ç´„ã—ã¾ã—ãŸã€‚

```
V3: Factory â†’ Pool A ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ
             â†’ Pool B ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ
             â†’ Pool C ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ  (ãã‚Œãã‚Œç‹¬ç«‹)

V4: PoolManager (ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³)
    â”œâ”€â”€ Pool A ã®çŠ¶æ…‹
    â”œâ”€â”€ Pool B ã®çŠ¶æ…‹
    â””â”€â”€ Pool C ã®çŠ¶æ…‹  (1ã¤ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã§ç®¡ç†)
```

**ãƒ¡ãƒªãƒƒãƒˆ**:

- **ãƒ—ãƒ¼ãƒ«ä½œæˆã‚³ã‚¹ãƒˆã®å¤§å¹…å‰Šæ¸›**: ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ãŒä¸è¦ã€‚çŠ¶æ…‹ã®æ›´æ–°ã®ã¿ã§æ¸ˆã‚€
- **ãƒãƒ«ãƒãƒ›ãƒƒãƒ—ã‚¹ãƒ¯ãƒƒãƒ—ã®åŠ¹ç‡åŒ–**: åŒä¸€ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆå†…ãªã®ã§ä¸­é–“ãƒˆãƒ¼ã‚¯ãƒ³ã®å®Ÿè»¢é€ãŒä¸è¦
- **ã‚ˆã‚Šã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: é–‹ç™ºè€…ã«ã¨ã£ã¦ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®¹æ˜“

## 3. Flash Accountingï¼ˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ã‚«ã‚¦ãƒ³ãƒ†ã‚£ãƒ³ã‚°ï¼‰

**Flash Accounting** ã¯ã€ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³è¨­è¨ˆã¨ **EIP-1153ï¼ˆTransient Storageï¼‰** ã‚’æ´»ç”¨ã—ãŸé©æ–°çš„ãªæœ€é©åŒ–æ©Ÿèƒ½ã§ã™ã€‚

https://docs.uniswap.org/contracts/v4/concepts/flash-accounting

### V3 ã®å•é¡Œ

V3 ã§ã¯ã€ãƒãƒ«ãƒãƒ›ãƒƒãƒ—ã‚¹ãƒ¯ãƒƒãƒ—ã§ä¸­é–“ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã«ãƒˆãƒ¼ã‚¯ãƒ³ã®å®Ÿéš›ã®è»¢é€ï¼ˆ`transfer()`ï¼‰ãŒç™ºç”Ÿã—ã¦ã„ã¾ã—ãŸã€‚

```
V3: ETHâ†’USDC ã‚¹ãƒ¯ãƒƒãƒ— â†’ USDC transfer() â†’ USDCâ†’DAI ã‚¹ãƒ¯ãƒƒãƒ— â†’ DAI transfer()
    ï¼ˆä¸­é–“ã®ãƒˆãƒ¼ã‚¯ãƒ³è»¢é€ãŒæ¯å›ç™ºç”Ÿï¼‰
```

### V4 ã®ä»•çµ„ã¿

V4 ã§ã¯ã€ä¸€é€£ã®æ“ä½œä¸­ã¯ **å†…éƒ¨çš„ãªæ®‹é«˜ï¼ˆdeltaï¼‰ã®è¨˜éŒ²ã®ã¿** ã‚’è¡Œã„ã€**æœ€å¾Œã«ã¾ã¨ã‚ã¦ç²¾ç®—** ã—ã¾ã™ã€‚

```
V4: unlock() â†’ swap(ETHâ†’USDC) â†’ swap(USDCâ†’DAI) â†’ settle(ETHæ”¯æ‰•ã„) + take(DAIå—å–ã‚Š)
    ï¼ˆä¸­é–“ã®USDCè»¢é€ã¯ä¸è¦ï¼å…¥åŠ›ã¨å‡ºåŠ›ã®2å›ã ã‘ï¼‰
```

### ãƒ­ãƒƒã‚­ãƒ³ã‚°ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

Flash Accounting ã¯ä»¥ä¸‹ã®3ã‚¹ãƒ†ãƒƒãƒ—ã§å‹•ä½œã—ã¾ã™ã€‚

1. **`unlock()`** ã§ PoolManager ã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤
2. **`unlockCallback`** å†…ã§ã‚¹ãƒ¯ãƒƒãƒ—ã‚„æµå‹•æ€§æ“ä½œã‚’å®Ÿè¡Œï¼ˆã“ã®é–“ã¯deltaã®ã¿è¨˜éŒ²ï¼‰
3. ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯çµ‚äº†æ™‚ã«ã™ã¹ã¦ã® **delta ãŒ0 ã«ç²¾ç®—** ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

:::message alert
**é‡è¦**: `unlockCallback` ã‹ã‚‰åˆ¶å¾¡ãŒ PoolManager ã«æˆ»ã‚‹éš›ã€ã™ã¹ã¦ã®æ®‹é«˜å¤‰æ›´ï¼ˆdeltaï¼‰ãŒè§£æ±ºã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æœªæ±ºæ¸ˆã®æ®‹é«˜ãŒæ®‹ã£ã¦ã„ã‚‹ã¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯å¤±æ•—ã—ã¾ã™ã€‚
:::

### ã‚¬ã‚¹å‰Šæ¸›ã®åŠ¹æœ

ã“ã®æœ€é©åŒ–ã¯ **ãƒ›ãƒƒãƒ—æ•°ãŒå¢—ãˆã‚‹ã»ã©åŠ¹æœãŒå¤§ãã** ãªã‚Šã¾ã™ã€‚  
ä½•ãƒ›ãƒƒãƒ—ã®ã‚¹ãƒ¯ãƒƒãƒ—ã§ã‚‚ã€å®Ÿéš›ã®ãƒˆãƒ¼ã‚¯ãƒ³è»¢é€ã¯ **å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³ã¨å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³ã®2å›ã ã‘** ã§ã™ã€‚

## 4. ãƒã‚¤ãƒ†ã‚£ãƒ–ETHã‚µãƒãƒ¼ãƒˆ

V3 ã§ã¯ ETH ã‚’ä½¿ã£ãŸã‚¹ãƒ¯ãƒƒãƒ—ã‚’è¡Œã†ã«ã¯ã€ã¾ãš ETH ã‚’ **WETHï¼ˆWrapped ETHï¼‰** ã«å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚ã“ã‚Œã«ã¯ä»¥ä¸‹ã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã—ãŸã€‚

- ãƒ©ãƒƒãƒ”ãƒ³ã‚°/ã‚¢ãƒ³ãƒ©ãƒƒãƒ”ãƒ³ã‚°ã®ã‚¬ã‚¹ã‚³ã‚¹ãƒˆ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®è¤‡é›‘åŒ–

V4 ã§ã¯ **ãƒã‚¤ãƒ†ã‚£ãƒ–ã® ETH** ã‚’ãã®ã¾ã¾ãƒ—ãƒ¼ãƒ«ãƒšã‚¢ã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€WETH ã¸ã®å¤‰æ›ã‚¹ãƒ†ãƒƒãƒ—ãŒä¸è¦ã«ãªã‚Šã€ã‚¬ã‚¹ã‚³ã‚¹ãƒˆå‰Šæ¸›ã¨UXã®å‘ä¸ŠãŒå®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

## 5. ERC-6909 ãƒˆãƒ¼ã‚¯ãƒ³è¦æ ¼

Uniswap V4 ã¯ **ERC-6909** ã¨ã„ã†æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³è¦æ ¼ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ ERC-1155 ã®è»½é‡ç‰ˆã¨ã‚‚ã„ãˆã‚‹è¦æ ¼ã§ã€1ã¤ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‹ã‚‰è¤‡æ•°ã®ERC-20ãƒˆãƒ¼ã‚¯ãƒ³ã‚’åŠ¹ç‡çš„ã«ç®¡ç†ã§ãã¾ã™ã€‚

https://eips.ethereum.org/EIPS/eip-6909

### ERC-6909 ã®åˆ©ç‚¹

| æ¯”è¼ƒé …ç›® | ERC-1155 | ERC-6909 |
|---------|----------|----------|
| ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ | è¤‡é›‘ | **ã‚·ãƒ³ãƒ—ãƒ«** |
| è»¢é€å§”ä»» | éåŠ¹ç‡ | **åŠ¹ç‡çš„** |
| ã‚¬ã‚¹ã‚³ã‚¹ãƒˆ | é«˜ã‚ | **ä½ã„** |
| ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚µã‚¤ã‚º | å¤§ãã„ | **å°ã•ã„** |

### ä»•çµ„ã¿

ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ PoolManager ã«é ã‘ãŸã¾ã¾ã«ã—ã€ä»£ã‚ã‚Šã« **ERC-6909 ã®ã‚¯ãƒ¬ãƒ¼ãƒ ãƒˆãƒ¼ã‚¯ãƒ³** ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æ¬¡å›ã®æ“ä½œæ™‚ã«ã¯ã“ã®ã‚¯ãƒ¬ãƒ¼ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã§ãã‚‹ã®ã§ã€ERC-20 ã®å¤–éƒ¨ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆå‘¼ã³å‡ºã—ãŒä¸è¦ã«ãªã‚Šã¾ã™ã€‚

**æ´»ç”¨ä¾‹**:
- **é«˜é »åº¦ãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ / MEV ãƒœãƒƒãƒˆ**: çŸ­æ™‚é–“ã«å¤šæ•°ã®ã‚¹ãƒ¯ãƒƒãƒ—ã‚’è¡Œã†ãƒ‘ãƒ¯ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æœ€é©
- **æµå‹•æ€§ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼**: é »ç¹ã«ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’é–‹é–‰ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æœ‰åˆ©

## 6. ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ•ã‚£ãƒ¼ï¼ˆDynamic Feesï¼‰

V3 ã§ã¯æ‰‹æ•°æ–™ã¯å›ºå®šã®ãƒ†ã‚£ã‚¢ï¼ˆ0.05%ã€0.30%ã€1.0%ï¼‰ã‹ã‚‰é¸æŠã™ã‚‹æ–¹å¼ã§ã—ãŸã€‚V4 ã§ã¯ **Hooks ã‚’ä½¿ã£ã¦æ‰‹æ•°æ–™ã‚’å‹•çš„ã«å¤‰æ›´** ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

https://docs.uniswap.org/contracts/v4/concepts/dynamic-fees

### ä¸»ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

1. **ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ™ãƒ¼ã‚¹**: ä¾¡æ ¼å¤‰å‹•ãŒæ¿€ã—ã„æ™‚ã¯æ‰‹æ•°æ–™ã‚’ä¸Šã’ã¦LPã‚’ä¿è­·
2. **ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ™ãƒ¼ã‚¹**: å–å¼•é‡ãŒå¤šã„æ™‚ã¯æ‰‹æ•°æ–™ã‚’ä¸‹ã’ã¦ãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ã‚’èª˜å¼•
3. **æ™‚é–“ãƒ™ãƒ¼ã‚¹**: æ™‚é–“å¸¯ã‚„æ›œæ—¥ã«å¿œã˜ãŸæ‰‹æ•°æ–™è¨­å®š
4. **ã‚¬ã‚¹ä¾¡æ ¼é€£å‹•**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ··é›‘æ™‚ã«æ‰‹æ•°æ–™ã‚’èª¿æ•´
5. **ã‚¯ãƒ­ã‚¹ãƒ—ãƒ¼ãƒ«ã‚¢ãƒ¼ãƒ“ãƒˆãƒ©ãƒ¼ã‚¸ç·©å’Œ**: æœ‰å®³ãªã‚¢ãƒ¼ãƒ“ãƒˆãƒ©ãƒ¼ã‚¸ã‚’æŠ‘åˆ¶
6. **ä¾¡æ ¼ã‚ªãƒ©ã‚¯ãƒ«é€£å‹•**: å¤–éƒ¨ã‚ªãƒ©ã‚¯ãƒ«ä¾¡æ ¼ã¨ã®ä¹–é›¢ã«å¿œã˜ã¦èª¿æ•´

### æ›´æ–°æ–¹æ³•

ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ•ã‚£ãƒ¼ã¯ä»¥ä¸‹ã®2ã¤ã®æ–¹æ³•ã§æ›´æ–°ã§ãã¾ã™ã€‚

1. **`PoolManager.updateDynamicLPFee()`** ã‚’å®šæœŸçš„ã«å‘¼ã³å‡ºã™
2. **`beforeSwap` Hook** ã§ã‚¹ãƒ¯ãƒƒãƒ—ã”ã¨ã«æ‰‹æ•°æ–™ã‚’è¿”ã™

## V3 vs V4 ã¾ã¨ã‚

æœ€å¾Œã«ã€V3 ã¨ V4 ã®é•ã„ã‚’ä¸€è¦§è¡¨ã§ã¾ã¨ã‚ã¾ã™ã€‚

| æ©Ÿèƒ½ | V3 | V4 |
|------|----|----|
| **é›†ä¸­æµå‹•æ€§** | âœ… | âœ…ï¼ˆç¶™æ‰¿ï¼‰ |
| **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£** | Factory + å€‹åˆ¥Pool | **ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ï¼ˆPoolManagerï¼‰** |
| **ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚¸ãƒƒã‚¯** | âŒ | âœ… **Hooks** |
| **ä¸­é–“ãƒˆãƒ¼ã‚¯ãƒ³è»¢é€** | æ¯ãƒ›ãƒƒãƒ—ã§å¿…è¦ | **Flash Accounting ã§ä¸è¦** |
| **ãƒã‚¤ãƒ†ã‚£ãƒ–ETH** | âŒï¼ˆWETHå¿…é ˆï¼‰ | âœ… |
| **æ‰‹æ•°æ–™** | å›ºå®šãƒ†ã‚£ã‚¢ | **ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ•ã‚£ãƒ¼å¯¾å¿œ** |
| **ãƒˆãƒ¼ã‚¯ãƒ³è¦æ ¼** | â€” | **ERC-6909** |
| **ãƒ—ãƒ¼ãƒ«ä½œæˆã‚³ã‚¹ãƒˆ** | é«˜ã„ï¼ˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰ | **ä½ã„ï¼ˆçŠ¶æ…‹æ›´æ–°ã®ã¿ï¼‰** |
| **ã‚¹ãƒ†ãƒ¼ã‚­ãƒ³ã‚°** | NFTè»¢é€ãŒå¿…è¦ | **Subscribers ã§è»¢é€ä¸è¦** |

# UniswapV4ã«å¯¾å¿œã—ãŸã‚ªãƒªã‚¸ãƒŠãƒ«Hookã‚’ä½œã£ã¦ã¿ã‚ˆã†ï¼

ãã‚Œã§ã¯æ—©é€Ÿã‚ªãƒªã‚¸ãƒŠãƒ«Hookã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ï¼

ä»¥ä¸‹ã®å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸï¼

https://updraft.cyfrin.io/courses/uniswap-v4

## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

https://github.com/mashharuki/defi-uniswap-v4

## å‹•ã‹ã—æ–¹

### Devcontainerã‚’ç«‹ã¡ä¸Šã’ã‚‹

ã¾ãšã¯Devcontainerã‚’èµ·å‹•ã•ã›ã¾ã—ã‚‡ã†ï¼  
ã“ã‚Œã§å¿…è¦ãªãƒ„ãƒ¼ãƒ«ç¾¤ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸç’°å¢ƒãŒç”¨æ„ã§ãã¾ã™ï¼

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

git submoduleã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ããŸã‚‰ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
git submodule update --init --recursive
```

ä»¥é™ã®ã‚³ãƒãƒ³ãƒ‰ã¯`foundry`ãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã§å®Ÿè¡Œã—ã¾ã™ã€‚

### äº‹å‰æº–å‚™

- Alchemyç­‰ã®RPCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§Ethereumãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒˆç”¨ã®APIã‚­ãƒ¼ã‚’ç™ºè¡Œã™ã‚‹ã“ã¨

    https://www.alchemy.com/

- ä¸Šè¨˜å€¤ã‚’ç’°å¢ƒå¤‰æ•°ã«ã‚»ãƒƒãƒˆã™ã‚‹ã€‚

    ```bash
    FORK_URL=
    ```

    ãã—ã¦ç’°å¢ƒå¤‰æ•°æœ‰åŠ¹åŒ–ã•ã›ã¾ã™

    ```bash
    source .env
    ```

- æ¬¡ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§æœ€æ–°ãƒ–ãƒ­ãƒƒã‚¯é«˜ã‚’å–å¾—ã™ã‚‹

    ```bash
    FORK_BLOCK_NUM=$(cast block-number --rpc-url $FORK_URL)
    echo $FORK_BLOCK_NUM
    ```

- æ¬¡ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§Saltã‚’ç™ºè¡Œã™ã‚‹

    ```bash
    forge test --match-path test/FindHookSalt.test.sol -vvv
    ```

    ã“ã“ã§å¾—ã‚‰ã‚ŒãŸSALTã‚’ç’°å¢ƒå¤‰æ•°ã«ã‚»ãƒƒãƒˆã™ã‚‹

    ```bash
    SALT=
    ```

    ãã—ã¦å†åº¦æœ‰åŠ¹åŒ–ã•ã›ã¾ã™ã€‚

    ```bash
    source .env
    ```

    ã“ã‚Œã§æº–å‚™OKã§ã™ï¼

### CounterHookã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®å®Ÿè£…

ã¾ãšãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒä»¥ä¸‹ã§ã™ã€‚

ã“ã“ã«è¿½åŠ ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

```ts
// SPDX-License-Identifier: MIT
pragma solidity 0.8.30;

import {IPoolManager} from "../interfaces/IPoolManager.sol";
import {Hooks} from "../libraries/Hooks.sol";
import {PoolId, PoolIdLibrary} from "../types/PoolId.sol";
import {PoolKey} from "../types/PoolKey.sol";
import {SwapParams, ModifyLiquidityParams} from "../types/PoolOperation.sol";
import {BalanceDelta} from "../types/BalanceDelta.sol";
import {
    BeforeSwapDelta,
    BeforeSwapDeltaLibrary
} from "../types/BeforeSwapDelta.sol";

contract CounterHook {
    using PoolIdLibrary for PoolKey;

    error NotPoolManager();
    error HookNotImplemented();

    IPoolManager public immutable poolManager;

    mapping(PoolId => mapping(string => uint256)) public counts;

    modifier onlyPoolManager() {
        if (msg.sender != address(poolManager)) revert NotPoolManager();
        _;
    }

    constructor(address _poolManager) {
        poolManager = IPoolManager(_poolManager);
        Hooks.validateHookPermissions(address(this), getHookPermissions());
    }

    function getHookPermissions()
        public
        pure
        returns (Hooks.Permissions memory)
    {
        return Hooks.Permissions({
            beforeInitialize: false,
            afterInitialize: false,
            beforeAddLiquidity: false,
            afterAddLiquidity: false,
            beforeRemoveLiquidity: false,
            afterRemoveLiquidity: false,
            beforeSwap: false,
            afterSwap: false,
            beforeDonate: false,
            afterDonate: false,
            beforeSwapReturnDelta: false,
            afterSwapReturnDelta: false,
            afterAddLiquidityReturnDelta: false,
            afterRemoveLiquidityReturnDelta: false
        });
    }

    function beforeInitialize(
        address sender,
        PoolKey calldata key,
        uint160 sqrtPriceX96
    ) external onlyPoolManager returns (bytes4) {
        revert HookNotImplemented();
    }

    function afterInitialize(
        address sender,
        PoolKey calldata key,
        uint160 sqrtPriceX96,
        int24 tick
    ) external onlyPoolManager returns (bytes4) {
        revert HookNotImplemented();
    }

    function beforeSwap(
        address sender,
        PoolKey calldata key,
        SwapParams calldata params,
        bytes calldata hookData
    ) external onlyPoolManager returns (bytes4, BeforeSwapDelta, uint24) {
        return (this.beforeSwap.selector, BeforeSwapDeltaLibrary.ZERO_DELTA, 0);
    }

    function afterSwap(
        address sender,
        PoolKey calldata key,
        SwapParams calldata params,
        BalanceDelta delta,
        bytes calldata hookData
    ) external onlyPoolManager returns (bytes4, int128) {
        return (this.afterSwap.selector, 0);
    }

    function beforeAddLiquidity(
        address sender,
        PoolKey calldata key,
        ModifyLiquidityParams calldata params,
        bytes calldata hookData
    ) external onlyPoolManager returns (bytes4) {
        return this.beforeAddLiquidity.selector;
    }

    function afterAddLiquidity(
        address sender,
        PoolKey calldata key,
        ModifyLiquidityParams calldata params,
        BalanceDelta delta,
        BalanceDelta feesAccrued,
        bytes calldata hookData
    ) external onlyPoolManager returns (bytes4, BalanceDelta) {
        revert HookNotImplemented();
    }

    function beforeRemoveLiquidity(
        address sender,
        PoolKey calldata key,
        ModifyLiquidityParams calldata params,
        bytes calldata hookData
    ) external onlyPoolManager returns (bytes4) {
        return this.beforeRemoveLiquidity.selector;
    }

    function afterRemoveLiquidity(
        address sender,
        PoolKey calldata key,
        ModifyLiquidityParams calldata params,
        BalanceDelta delta,
        BalanceDelta feesAccrued,
        bytes calldata hookData
    ) external onlyPoolManager returns (bytes4, BalanceDelta) {
        revert HookNotImplemented();
    }

    function beforeDonate(
        address sender,
        PoolKey calldata key,
        uint256 amount0,
        uint256 amount1,
        bytes calldata hookData
    ) external onlyPoolManager returns (bytes4) {
        revert HookNotImplemented();
    }

    function afterDonate(
        address sender,
        PoolKey calldata key,
        uint256 amount0,
        uint256 amount1,
        bytes calldata hookData
    ) external onlyPoolManager returns (bytes4) {
        revert HookNotImplemented();
    }
}
```

#### ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ç”¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°å¤‰æ•°ã®è¿½åŠ 

ä»¥ä¸‹ã®å¤‰æ•°ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```ts
// ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®ãƒãƒƒãƒ”ãƒ³ã‚°: PoolId => (ãƒ•ãƒƒã‚¯å => ã‚«ã‚¦ãƒ³ãƒˆ)
mapping(PoolId => mapping(string => uint256)) public counts;
```

#### getHookPermissionsãƒ¡ã‚½ãƒƒãƒ‰ã®å¤‰æ›´

ãƒˆãƒ¼ã‚¯ãƒ³ã‚¹ãƒ¯ãƒƒãƒ—ã®å‰å¾Œã§hookæ©Ÿèƒ½ãŒä½¿ãˆã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```ts
/**
 * ãƒ•ãƒƒã‚¯ã®æ¨©é™ã‚’å–å¾—ã—ã¾ã™
 * @return ãƒ•ãƒƒã‚¯ã®æ¨©é™
 */
function getHookPermissions()
    public
    pure
    returns (Hooks.Permissions memory)
{
    return Hooks.Permissions({
        beforeInitialize: false,
        afterInitialize: false,
        beforeAddLiquidity: true,
        afterAddLiquidity: false,
        beforeRemoveLiquidity: true,
        afterRemoveLiquidity: false,
        beforeSwap: true,  // Swapã®å‰ã«ãƒ•ãƒƒã‚¯ã‚’æœ‰åŠ¹åŒ–
        afterSwap: true,   // Swapã®å¾Œã«ãƒ•ãƒƒã‚¯ã‚’æœ‰åŠ¹åŒ–
        beforeDonate: false,
        afterDonate: false,
        beforeSwapReturnDelta: false,
        afterSwapReturnDelta: false,
        afterAddLiquidityReturnDelta: false,
        afterRemoveLiquidityReturnDelta: false
    });
}
```

#### beforeSwapãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…

ãƒˆãƒ¼ã‚¯ãƒ³ã‚’swapã™ã‚‹å‰ã«CounterãŒã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã—ã¾ã™ï¼

```ts
/**
 * Swapã®å‰ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ•ãƒƒã‚¯
 * @param sender spender address
 * @param key  ãƒ—ãƒ¼ãƒ«ã‚­ãƒ¼
 * @param params ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼
 * @param hookData ãƒ•ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
 */
function beforeSwap(
    address sender,
    PoolKey calldata key,
    SwapParams calldata params,
    bytes calldata hookData
) external onlyPoolManager returns (bytes4, BeforeSwapDelta, uint24) {
    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    counts[key.toId()]["beforeSwap"]++;
    return (this.beforeSwap.selector, BeforeSwapDeltaLibrary.ZERO_DELTA, 0);
}
```

#### afterSwapãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…

åŒã˜ã‚ˆã†ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’swapã—ãŸå¾Œã«CounterãŒã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›´æ–°ã—ã¾ã™ã€‚

```ts
/**
 * Swapã®å¾Œã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ•ãƒƒã‚¯
 */
function afterSwap(
    address sender,
    PoolKey calldata key,
    SwapParams calldata params,
    BalanceDelta delta,
    bytes calldata hookData
) external onlyPoolManager returns (bytes4, int128) {
    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    counts[key.toId()]["afterSwap"]++;
    return (this.afterSwap.selector, 0);
}
```

#### beforeAddLiquidityãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…

æ¬¡ã«æµå‹•æ€§ã‚’è¿½åŠ ã™ã‚‹å‰ã«CounterãŒã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«beforeAddLiquidityã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›´æ–°ã—ã¾ã™ã€‚

```ts
/**
 * æµå‹•æ€§ã‚’æä¾›ã™ã‚‹å‰ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ•ãƒƒã‚¯
 */
function beforeAddLiquidity(
    address sender,
    PoolKey calldata key,
    ModifyLiquidityParams calldata params,
    bytes calldata hookData
) external onlyPoolManager returns (bytes4) {
    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    counts[key.toId()]["beforeAddLiquidity"]++;
    return this.beforeAddLiquidity.selector;
}
```

#### beforeRemoveLiquidityãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…

æ¬¡ã«æµå‹•æ€§ã‚’å–ã‚Šé™¤ãå‰ã«CounterãŒã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«beforeRemoveLiquidityã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›´æ–°ã—ã¾ã™ã€‚

```ts
function beforeRemoveLiquidity(
    address sender,
    PoolKey calldata key,
    ModifyLiquidityParams calldata params,
    bytes calldata hookData
) external onlyPoolManager returns (bytes4) {
    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    counts[key.toId()]["beforeRemoveLiquidity"]++;
    return this.beforeRemoveLiquidity.selector;
}
```

ã“ã‚Œã§OKã§ã™ï¼

### ãƒ“ãƒ«ãƒ‰

ã§ã¯ãƒ“ãƒ«ãƒ‰ãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã‘ã‚Œã°OKã§ã™ï¼

```bash
forge build
```

### ãƒ†ã‚¹ãƒˆ

ãã‚Œã§ã¯ãƒ†ã‚¹ãƒˆã‚‚ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼

ã¾ãšEthereumãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒˆã®ç¾åœ¨ã®ãƒ–ãƒ­ãƒƒã‚¯é«˜ã‚’å–å¾—ã—ã€ç’°å¢ƒå¤‰æ•°åŒ–ã—ã¾ã™ã€‚

```bash
FORK_BLOCK_NUM=$(cast block-number --rpc-url $FORK_URL)
echo $FORK_BLOCK_NUM
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§å®Ÿéš›ã«ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã›ãšã¨ã‚‚æ“¬ä¼¼çš„ã«ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ï¼

ã“ã“ã¯**foundryã‚’ä½¿ã£ãŸé–‹ç™ºã®ãƒ¡ãƒªãƒƒãƒˆ**ã§ã™ã­ï¼

```bash
forge test --fork-url $FORK_URL --fork-block-number $FORK_BLOCK_NUM --match-path test/CounterHook.test.sol -vvv
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Œã°OKã§ã™ï¼

```bash
Suite result: ok. 3 passed; 0 failed; 0 skipped; finished in 44.85s (42.33s CPU time)

Ran 1 test suite in 50.55s (44.85s CPU time): 3 tests passed, 0 failed, 0 skipped (3 total tests)
```

#### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®è§£èª¬

CounterHookã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼

ãƒˆãƒ¼ã‚¯ãƒ³ã‚¹ãƒ¯ãƒƒãƒ—ã™ã‚‹å‰å¾Œã€æµå‹•æ€§ã®è¿½åŠ ãƒ»å‰Šé™¤ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§Counterã‚’å¢—ãˆã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¨ãªã£ã¦ã„ã¾ã™ï¼

```ts
// SPDX-License-Identifier: MIT
pragma solidity 0.8.30;

import {Test, console} from "forge-std/Test.sol";
import {IERC20} from "../src/interfaces/IERC20.sol";
import {IPoolManager} from "../src/interfaces/IPoolManager.sol";
import {SafeCast} from "../src/libraries/SafeCast.sol";
import {Hooks} from "../src/libraries/Hooks.sol";
import {PoolId, PoolIdLibrary} from "../src/types/PoolId.sol";
import {PoolKey} from "../src/types/PoolKey.sol";
import {
    SwapParams, ModifyLiquidityParams
} from "../src/types/PoolOperation.sol";
import {
    BalanceDelta, BalanceDeltaLibrary
} from "../src/types/BalanceDelta.sol";
import {
    POOL_MANAGER,
    USDC,
    MIN_TICK,
    MAX_TICK,
    MIN_SQRT_PRICE
} from "../src/Constants.sol";
import {CounterHook} from "@exercises/CounterHook.sol";

/**
 * CounterHookã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ†ã‚¹ãƒˆç”¨ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ 
 */
contract CounterHookTest is Test {
    using PoolIdLibrary for PoolKey;
    using BalanceDeltaLibrary for BalanceDelta;
    using SafeCast for int128;
    using SafeCast for uint128;

    IERC20 constant usdc = IERC20(USDC);
    IPoolManager constant poolManager = IPoolManager(POOL_MANAGER);
    PoolKey key;
    CounterHook hook;

    int24 constant TICK_SPACING = 10;
    int256 constant LIQUIDITY_DELTA = 1e12;

    uint256 constant SWAP = 1;
    uint256 constant ADD_LIQUIDITY = 2;
    uint256 constant REMOVE_LIQUIDITY = 3;
    uint256 action;

    /**
     * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–¢æ•°
     */
    function setUp() public {
        console.log("Deployer", address(this));
        // SALTã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã™ã‚‹
        bytes32 salt = vm.envBytes32("SALT");
        console.log("SALT");
        console.logBytes32(salt);
        // CounterHookã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤
        hook = new CounterHook{salt: salt}(POOL_MANAGER);
        // ãƒ—ãƒ¼ãƒ«ã®åˆæœŸåŒ–(ETH/USDC 0.05% fee)
        key = PoolKey({
            currency0: address(0),
            currency1: USDC,
            fee: 500,
            tickSpacing: TICK_SPACING,
            hooks: address(hook)
        });
        // ãƒ—ãƒ¼ãƒ«ã®åˆæœŸä¾¡æ ¼ã‚’è¨­å®šï¼ˆ1 ETH = 1,000,000 USDCï¼‰
        poolManager.initialize(key, 1e6 * (1 << 96));
        // ãƒ†ã‚¹ãƒˆç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«åˆæœŸè³‡é‡‘ã‚’ä»˜ä¸
        deal(USDC, address(this), 1e6 * 1e6);
        deal(address(this), 1e6 * 1e18);
    }

    receive() external payable {}

    /**
     * unlockCallbacké–¢æ•°
     * unlockãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚ŒãŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
     */
    function unlockCallback(bytes calldata data)
        external
        returns (bytes memory)
    {
        if (action == ADD_LIQUIDITY) {
            // ãƒ—ãƒ¼ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‹ã‚‰modifyLiquidityã‚’å‘¼ã³å‡ºã™(æµå‹•æ€§ã®è¿½åŠ )
            (int256 d,) = poolManager.modifyLiquidity({
                key: key,
                params: ModifyLiquidityParams({
                    tickLower: MIN_TICK / TICK_SPACING * TICK_SPACING,
                    tickUpper: MAX_TICK / TICK_SPACING * TICK_SPACING,
                    liquidityDelta: LIQUIDITY_DELTA,
                    salt: bytes32(0)
                }),
                hookData: ""
            });
            BalanceDelta delta = BalanceDelta.wrap(d);

            if (delta.amount0() < 0) {
                uint256 amount0 = uint128(-delta.amount0());
                console.log("Add liquidity amount 0: %e", amount0);
                // ETHã®é€é‡‘
                poolManager.sync(key.currency0);
                poolManager.settle{value: amount0}();
            }
            if (delta.amount1() < 0) {
                uint256 amount1 = uint128(-delta.amount1());
                console.log("Add liquidity amount 1: %e", amount1);
                // USDCã®é€é‡‘
                deal(USDC, address(this), amount1);
                // USDCã‚’ãƒ—ãƒ¼ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«é€é‡‘
                poolManager.sync(key.currency1);
                usdc.transfer(address(poolManager), amount1);
                poolManager.settle();
            }
            return "";
        } else if (action == REMOVE_LIQUIDITY) {
            // ãƒ—ãƒ¼ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‹ã‚‰modifyLiquidityã‚’å‘¼ã³å‡ºã™(æµå‹•æ€§ã®å‰Šé™¤)
            (int256 d,) = poolManager.modifyLiquidity({
                key: key,
                params: ModifyLiquidityParams({
                    tickLower: MIN_TICK / TICK_SPACING * TICK_SPACING,
                    tickUpper: MAX_TICK / TICK_SPACING * TICK_SPACING,
                    liquidityDelta: -LIQUIDITY_DELTA,
                    salt: bytes32(0)
                }),
                hookData: ""
            });
            BalanceDelta delta = BalanceDelta.wrap(d);
            
            if (delta.amount0() > 0) {
                uint256 amount0 = uint128(delta.amount0());
                console.log("Remove liquidity amount 0: %e", amount0);
                // ETHã®å—ã‘å–ã‚Š
                poolManager.take(key.currency0, address(this), amount0);
            }
            if (delta.amount1() > 0) {
                uint256 amount1 = uint128(delta.amount1());
                console.log("Remove liquidity amount 1: %e", amount1);
                // USDCã®å—ã‘å–ã‚Š
                poolManager.take(key.currency1, address(this), amount1);
            }
            return "";
        } else if (action == SWAP) {
            // Swap ETH -> USDC
            uint256 bal = usdc.balanceOf(address(this));
            // ãƒ—ãƒ¼ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‹ã‚‰swapã‚’å‘¼ã³å‡ºã™(ãƒˆãƒ¼ã‚¯ãƒ³ã®äº¤æ›)
            int256 d = poolManager.swap({
                key: key,
                params: SwapParams({
                    zeroForOne: true,
                    amountSpecified: -(int256(bal)),
                    sqrtPriceLimitX96: MIN_SQRT_PRICE + 1
                }),
                hookData: ""
            });

            BalanceDelta delta = BalanceDelta.wrap(d);
            int128 amount0 = delta.amount0();
            int128 amount1 = delta.amount1();

            (
                address currencyIn,
                address currencyOut,
                uint256 amountIn,
                uint256 amountOut
            ) = (
                key.currency0,
                key.currency1,
                (-amount0).toUint256(),
                amount1.toUint256()
            );


            // ETHã®æ”¯æ‰•ã„
            poolManager.take({
                currency: currencyOut,
                to: address(this),
                amount: amountOut
            });
            // USDCã®é€é‡‘
            poolManager.sync(currencyIn);
            poolManager.settle{value: amountIn}();
            return "";
        }

        revert("Invalid action");
    }

    /**
     * æ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèªã™ã‚‹ãƒ†ã‚¹ãƒˆ
     */
    function test_permissions() public {
        Hooks.validateHookPermissions(address(hook), hook.getHookPermissions());
    }

    /**
     * æµå‹•æ€§ã®è¿½åŠ ãƒ»å‰Šé™¤ã®ãƒ†ã‚¹ãƒˆ
     * â€» ãã‚Œãã‚Œã®ãƒ•ãƒƒã‚¯ãŒæ­£ã—ãå‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
     */
    function test_liquidity() public {
        action = ADD_LIQUIDITY;
        poolManager.unlock("");
        assertEq(hook.counts(key.toId(), "beforeAddLiquidity"), 1);
        assertEq(hook.counts(key.toId(), "afterAddLiquidity"), 0);

        action = REMOVE_LIQUIDITY;
        poolManager.unlock("");
        assertEq(hook.counts(key.toId(), "beforeRemoveLiquidity"), 1);
        assertEq(hook.counts(key.toId(), "afterRemoveLiquidity"), 0);
    }

    /**
     * ã‚¹ãƒ¯ãƒƒãƒ—ã®ãƒ†ã‚¹ãƒˆ
     * â€» ãã‚Œãã‚Œã®ãƒ•ãƒƒã‚¯ãŒæ­£ã—ãå‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
     */
    function test_swap() public {
        action = SWAP;
        deal(USDC, address(this), 100 * 1e6);
        poolManager.unlock("");
        assertEq(hook.counts(key.toId(), "beforeSwap"), 1);
        assertEq(hook.counts(key.toId(), "afterSwap"), 1);
    }
}
```

# ã¾ã¨ã‚

ä»¥ä¸Š UniswapV4ã«ã¤ã„ã¦ã®è§£èª¬è¨˜äº‹ã«ãªã‚Šã¾ã™ï¼

Uniswap V4 ã¯ã€**Hooks** ã«ã‚ˆã‚‹åœ§å€’çš„ãªæ‹¡å¼µæ€§ã€**ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³è¨­è¨ˆ**ã¨**Flash Accounting** ã«ã‚ˆã‚‹ã‚¬ã‚¹æœ€é©åŒ–ã€**ãƒã‚¤ãƒ†ã‚£ãƒ–ETHå¯¾å¿œ**ã‚„**ERC-6909**ã€**ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ•ã‚£ãƒ¼** ã¨ã„ã£ãŸå¤šæ•°ã®é©æ–°çš„æ©Ÿèƒ½ã‚’å°å…¥ã—ã¾ã—ãŸã€‚

Swapã™ã‚‹å‰å¾Œã‚„æµå‹•æ€§ã®è¿½åŠ ãƒ»å‰Šé™¤ã«ä¼´ã£ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã›ã‚‹ã“ã¨ã§uniswapã®ä»•çµ„ã¿ã‚’å¿œç”¨ã—ãŸã‚¢ãƒ—ãƒªãŒé–‹ç™ºã—ã‚„ã™ããªã£ã¦ã„ã¾ã—ãŸã€‚

ç‰¹ã«Hooksã¯ã€Uniswap V4 ä¸Šã«ã¾ã£ãŸãæ–°ã—ã„DeFiãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’æ§‹ç¯‰ã™ã‚‹é“ã‚’é–‹ã„ãŸã¨ã„ã†ç‚¹ã§ã€ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã«ã¨ã£ã¦å¤§ããªã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãŒã‚ã‚Šã¾ã™ã€‚

çš†ã•ã‚“ã‚‚ãœã²ãŠè©¦ã—ã‚ã‚Œï¼

ã“ã“ã¾ã§èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼

# å‚è€ƒæ–‡çŒ®

- [Uniswap V4 å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.uniswap.org/contracts/v4/overview)
- [Uniswap V4 ãƒ›ãƒ¯ã‚¤ãƒˆãƒšãƒ¼ãƒ‘ãƒ¼](https://app.uniswap.org/whitepaper-v4.pdf)
- [Uniswap V4 Hooks](https://docs.uniswap.org/contracts/v4/concepts/hooks)
- [Flash Accounting](https://docs.uniswap.org/contracts/v4/concepts/flash-accounting)
- [PoolManager](https://docs.uniswap.org/contracts/v4/concepts/PoolManager)
- [Dynamic Fees](https://docs.uniswap.org/contracts/v4/concepts/dynamic-fees)
- [ERC-6909](https://docs.uniswap.org/contracts/v4/concepts/erc6909)
- [V4 vs V3](https://docs.uniswap.org/contracts/v4/concepts/v4-vs-v3)
- [Uniswap V4 Core ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/Uniswap/v4-core)
- [Uniswap V4 Periphery ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/Uniswap/v4-periphery)
- [EIP-1153: Transient Storage](https://eips.ethereum.org/EIPS/eip-1153)
- [EIP-6909: Minimal Multi-Token Interface](https://eips.ethereum.org/EIPS/eip-6909)