---
title: "Cloud Runå…¥é–€ - ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã§ãƒ‡ãƒ—ãƒ­ã‚¤"
emoji: "ğŸš€"
type: "tech"
topics: ["GoogleCloud", "CloudRun", "ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹", "ã‚³ãƒ³ãƒ†ãƒŠ", "ã‚¯ãƒ©ã‚¦ãƒ‰"]
published: true
---

![](/images/927e99dc0bf450/0.png)

## ã¯ã˜ã‚ã«

çš†ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼

ä»Šå›ã¯ **Google cloud** ãŒæä¾›ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚‹ **Cloud Run** ã‚’ãƒ†ãƒ¼ãƒã«ã—ãŸè¨˜äº‹ã‚’æ›¸ã„ã¦ã¿ã¾ã—ãŸï¼ï¼

å…¥é–€ç·¨ã¨ã—ã¦ **Cloud Run** ã®æ¦‚è¦ã«ã¤ã„ã¦ã‚‚ã¾ã¨ã‚ã¦ã„ã¾ã™ï¼

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«ãƒˆãƒ©ã‚¤ã—ãŸæ™‚ã®è¨˜éŒ²ã‚‚ã‚ã‚Šã¾ã™ã®ã§ãœã²æœ€å¾Œã¾ã§èª­ã‚“ã§ãã ã•ã„ï¼

---

## Cloud Runã¨ã¯ï¼Ÿ

Cloud Runã¯ã€Google CloudãŒæä¾›ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã®ä¸€ã¤ã§ã™ã€‚  
â€» 2024å¹´11æœˆã§ GAã«ãªã£ã¦ã‹ã‚‰ 5å‘¨å¹´ã¨ã®ã“ã¨ã§ã™ï¼

https://cloud.google.com/run/docs/overview/what-is-cloud-run?hl=ja

ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã€ç‰¹å®šã®ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ã‚„ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã®æ‰‹é–“ãªã—ã«ã€ç°¡å˜ã«ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»å®Ÿè¡Œã§ãã¾ã™ã€‚

AWSã«ã‚‚ä¼¼ãŸã‚ˆã†ãªã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ **Fargate** ãŒã‚ã‚Šã¾ã™ã€‚

**ç‰¹å¾´**ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ç‚¹ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

- **è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**
  ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿œã˜ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ã‚’è‡ªå‹•çš„ã«å¢—æ¸›

- **å®Œå…¨ãƒãƒãƒ¼ã‚¸ãƒ‰**
  ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ãŒä¸è¦

- **ã©ã‚“ãªè¨€èªã§ã‚‚å¯¾å¿œ**
  ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚ã‚Œã°ã€ã©ã‚“ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã‚‚å‹•ä½œå¯èƒ½

- **HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆé§†å‹•**
  å¤–éƒ¨ã‹ã‚‰ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼

- **è²»ç”¨åŠ¹ç‡**
  ä½¿ã£ãŸåˆ†ã ã‘æ–™é‡‘ãŒç™ºç”Ÿã—ã€ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã§ã¯èª²é‡‘ã•ã‚Œãªã„

---

## Cloud Runã‚’ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆ

Cloud Runã®æœ€å¤§ã®ãƒ¡ãƒªãƒƒãƒˆã¯ã€**ã‚³ãƒ³ãƒ†ãƒŠã‚’ãã®ã¾ã¾ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã§å®Ÿè¡Œã§ãã‚‹**ç‚¹ã§ã™ã€‚

- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**
  ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã«å¿œã˜ã¦è‡ªå‹•çš„ã«ã‚¹ã‚±ãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã€è² è·ã®å¤‰å‹•ãŒæ¿€ã—ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é©ã—ã¦ã„ã¾ã™ã€‚

- **é–‹ç™ºã‚¹ãƒ”ãƒ¼ãƒ‰å‘ä¸Š**
  ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ã‚’æ°—ã«ã›ãšã«ã€ã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…ã«é›†ä¸­ã§ãã‚‹ã€‚

- **ãƒãƒ«ãƒã‚¯ãƒ©ã‚¦ãƒ‰å¯¾å¿œ**
  æ¨™æº–çš„ãªDockerã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚„ä»–ã®ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã§ã‚‚å†åˆ©ç”¨ãŒå®¹æ˜“ã€‚

  ä¾‹ãˆã° Dockerfileã‚’ç”¨æ„ã™ã‚Œã° AWS Fargateãªã©ã§ã‚‚å‹•ã‹ã™ã“ã¨ãŒå¯èƒ½ã§ã™ã­ã€‚

  ãƒãƒ«ãƒã‚¯ãƒ©ã‚¦ãƒ‰ãŒä¸»æµã«ãªã£ã¦ã„ã‚‹ä»Šã€ã“ã®ç‚¹ã¯éå¸¸ã«é‡è¦ã§ã™ã­ï¼

---

## Cloud Runã®åŸºæœ¬çš„ãªä½¿ã„æ–¹

ä»Šå›ã¯3ã¤ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ãŸï¼

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦å‹•ã‹ã—ã¦ã¿ã‚‹ã‚‚ã®ã¨ã‚¸ãƒ§ãƒ–ã¨ã—ã¦å‹•ã‹ã—ã¦ã¿ã‚‹ã‚‚ã®ã§ã™ï¼ï¼

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦å‹•ã‹ã—ã¦ã¿ã‚‹ã‚‚ã®ã«ã¤ã„ã¦ã¯äº‹å‰ã«ç”¨æ„ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠä¸Šã§å‹•ã‹ã™ã‚‚ã®ã¨è‡ªåˆ†ã§ã‚«ã‚¹ã‚¿ãƒ ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã§å‹•ã‹ã™ã‚‚ã®ã®2é€±é¡ã«æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ãŸï¼

https://cloud.google.com/run/docs/quickstarts/deploy-container?hl=ja

https://cloud.google.com/run/docs/quickstarts/build-and-deploy/deploy-nodejs-service?hl=ja

https://cloud.google.com/run/docs/quickstarts/jobs/create-execute?hl=ja

- **ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**

  ã¾ãš gcloud CLIã‚’å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ï¼

  ```bash
  curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-477.0.0-linux-x86_64.tar.gz
  tar -xf google-cloud-cli-477.0.0-linux-x86_64.tar.gz

  ./google-cloud-sdk/install.sh
  ./google-cloud-sdk/bin/gcloud init
  ```

  ã“ã‚Œã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã§ãã‚Œã°OKã§ã™ï¼ï¼

- **äº‹å‰ã«ç”¨æ„ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦å‹•ã‹ã—ã¦ã¿ã‚‹**

  ã¾ãšã¯ã‚µãƒ¼ãƒ“ã‚¹APIã‚’æœ‰åŠ¹åŒ–ã—ã¦ã¿ã¾ã™ï¼

  ```bash
  gcloud services enable run.googleapis.com
  ```

  æ¬¡ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

  ```bash
  gcloud projects add-iam-policy-binding lyrical-art-273306 \
      --member=serviceAccount:429380797965-compute@developer.gserviceaccount.com \
      --role=roles/cloudbuild.builds.builder
  ```

  ã¡ãªã¿ã«ä»Šå›å‹•ã‹ã™ã®ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªéå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ãª Express + Node.js ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ï¼

  ```js
  import express from 'express';
  const app = express();

  app.get('/', (req, res) => {
    const name = process.env.NAME || 'World';
    res.send(`Hello ${name}!`);
  });

  const port = parseInt(process.env.PORT) || 8080;
  app.listen(port, () => {
    console.log(`helloworld: listening on port ${port}`);
  });
  ```

  ä»Šå›ã¯ã€ Google Cloud å´ã§äº‹å‰ã«ç”¨æ„ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠä¸Šã§å‹•ã‹ã—ã¦ã¿ã¾ã™(ãã®ãŸã‚Dockerfileã¯ä¸è¦ã§ã™)ï¼

  ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ï¼

  ```bash
  gcloud run deploy
  ```

  ã—ã°ã‚‰ãå¾…ã¤ã¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå‡ºåŠ›ã•ã‚Œã¾ã™ï¼

  ```bash
  Service [helloworld] revision [helloworld-00001-n5w] has been deployed and is serving 100 percent of traffic.
  Service URL: https://helloworld-tbj5qgjmvq-bq.a.run.app
  ```

  **Service URL** ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ `Hello World!`ã¨è¡¨ç¤ºã•ã‚ŒãŸã‚‰OKã§ã™ï¼

  ã‚ã¡ã‚ƒãã¡ã‚ƒç°¡å˜ã§ã™ã­ï¼ï¼

  ã³ã£ãã‚Šã—ã¾ã—ãŸï¼

  ä¸€å¿œã€ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«å´ã§ã‚‚ç¢ºèªã—ã¦ã¿ã¾ã™ï¼ï¼

  ![](/images/927e99dc0bf450/1.png)

- **è‡ªåˆ†ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã—ã¦ã¿ã‚‹**

  æ¬¡ã¯è‡ªåˆ†ã§ Dockerfileã‚’ç”¨æ„ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã—ã¦ã¿ã¾ã™ï¼

  ã‚‚ã‚ã‚‚ã‚æ¡ä»¶ãŒã‚ã‚‹ã¿ãŸã„ãªã®ã§è¦ç¢ºèªã®ã“ã¨ã€‚

  - ã‚µãƒ¼ãƒ“ã‚¹ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
    ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€ä¿¡ã«ä½¿ã‚ã‚Œã‚‹ãƒãƒ¼ãƒˆã‚’æ§‹æˆã§ãã¾ã™ã€‚   

    Cloud Run ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…ã§ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å…ˆãƒãƒ¼ãƒˆãŒ PORT ç’°å¢ƒå¤‰æ•°ã®å€¤ã«å¸¸ã«åæ˜ ã•ã‚Œã¾ã™ã€‚  

    ã“ã® PORT ç’°å¢ƒå¤‰æ•°ãŒå­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹ã‚’ã‚³ãƒ¼ãƒ‰ã§æ¤œæŸ»ã—ã¦ãã ã•ã„ã€‚å­˜åœ¨ã™ã‚‹å ´åˆã¯ã€ç§»æ¤æ€§ãŒæœ€å¤§ã«ãªã‚‹ã‚ˆã†ãã®ãƒãƒ¼ãƒˆã§ãƒªãƒƒã‚¹ãƒ³ã™ã‚‹ã®ãŒé©åˆ‡ã§ã™ã€‚

  - ã‚µãƒ¼ãƒ“ã‚¹ã¯ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ°¸ç¶šçš„ãªãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã«ä¾å­˜ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
  
  - ã‚µãƒ¼ãƒ“ã‚¹ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã®ç¯„å›²å¤–ã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã€[CPU ã‚’å¸¸ã«å‰²ã‚Šå½“ã¦ã‚‹] è¨­å®šã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

  - ã‚µãƒ¼ãƒ“ã‚¹ãŒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ãƒ•ã‚¡ã‚¤ãƒ« ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ç¬¬ 2 ä¸–ä»£ã®å®Ÿè¡Œç’°å¢ƒã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

  ç¬¬ï¼’ä¸–ä»£ã®å®Ÿè¡Œç’°å¢ƒã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆã‚’å‚ç…§ã®ã“ã¨

  https://cloud.google.com/run/docs/about-execution-environments?hl=ja

  ä»¥ä¸‹ã§æœ€æ–°åŒ–

  ```bash
  gcloud components update
  ```

  ãƒ†ãƒ³ãƒ—ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’cloneã™ã‚‹ã€‚

  ```bash
  git clone https://github.com/GoogleCloudPlatform/nodejs-docs-samples.git
  ```

  ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®æ ¼ç´å…ˆã«ç§»å‹•ã™ã‚‹ã€‚

  ```bash
  cd nodejs-docs-samples/run/system-package/
  ```

  ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’`Dockerfile`ã«è¿½åŠ ã™ã‚‹ã€‚

  ```bash
  RUN apt-get update -y && apt-get install -y graphviz && apt-get clean
  ```

  ä¸­èº«ã®æ§‹é€ ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

  ```bash
  .
  â”œâ”€â”€ Dockerfile
  â”œâ”€â”€ README.md
  â”œâ”€â”€ app.js
  â”œâ”€â”€ index.js
  â”œâ”€â”€ package.json
  â””â”€â”€ test
      â”œâ”€â”€ app.test.js
      â”œâ”€â”€ e2e_test_cleanup.yaml
      â”œâ”€â”€ e2e_test_setup.yaml
      â”œâ”€â”€ retry.sh
      â””â”€â”€ system.test.js
  ```

  `Dockerfile`ã®ä¸­èº«ã¯ä»¥ä¸‹ã®é€šã‚Š

  ```yaml
  FROM node:20-alpine

  WORKDIR /usr/src/app

  RUN apt-get update -y && apt-get install -y graphviz && apt-get clean
  # RUN apk --no-cache add graphviz ttf-ubuntu-font-family

  COPY package*.json ./

  RUN npm install --only=production

  COPY . .

  CMD [ "npm", "start" ]
  ```

  package.json ã®ä¸­èº«ã¯ä»¥ä¸‹ã®é€šã‚Š

  ```json
  {
    "name": "graphviz-web",
    "version": "1.0.0",
    "description": "Demonstrates a Cloud Run service which provides a CLI tool over HTTP.",
    "main": "index.js",
    "private": true,
    "scripts": {
      "start": "node index.js",
      "test": "c8 mocha -p -j 2 test/app.test.js --check-leaks",
      "system-test": "echo 'SKIPPING E2E TEST: SEE b/358734748'",
      "FIXME-system-test": "c8 mocha -p -j 2 test/system.test.js --timeout=360000 --exit"
    },
    "engines": {
      "node": ">=18.0.0"
    },
    "dependencies": {
      "express": "^4.17.1"
    },
    "devDependencies": {
      "c8": "^10.0.0",
      "google-auth-library": "^9.0.0",
      "got": "^11.5.0",
      "mocha": "^10.0.0",
      "supertest": "^7.0.0"
    }
  }
  ```

  ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã€‚

  ```bash
  docker build .
  ```

  ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ `app.js`ã®ä¸­èº«

  ```ts
  // Copyright 2019 Google LLC
  //
  // Licensed under the Apache License, Version 2.0 (the "License");
  // you may not use this file except in compliance with the License.
  // You may obtain a copy of the License at
  //
  //     https://www.apache.org/licenses/LICENSE-2.0
  //
  // Unless required by applicable law or agreed to in writing, software
  // distributed under the License is distributed on an "AS IS" BASIS,
  // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  // See the License for the specific language governing permissions and
  // limitations under the License.

  const {execSync} = require('child_process');
  const fs = require('fs');

  const express = require('express');
  const app = express();

  // Verify the the dot utility is available at startup
  // instead of waiting for a first request.
  fs.accessSync('/usr/bin/dot', fs.constants.X_OK);

  // [START cloudrun_system_package_handler]
  app.get('/diagram.png', (req, res) => {
    try {
      const image = createDiagram(req.query.dot);
      res.setHeader('Content-Type', 'image/png');
      res.setHeader('Content-Length', image.length);
      res.setHeader('Cache-Control', 'public, max-age=86400');
      res.send(image);
    } catch (err) {
      console.error(`error: ${err.message}`);
      const errDetails = (err.stderr || err.message).toString();
      if (errDetails.includes('syntax')) {
        res.status(400).send(`Bad Request: ${err.message}`);
      } else {
        res.status(500).send('Internal Server Error');
      }
    }
  });
  // [END cloudrun_system_package_handler]

  // [START cloudrun_system_package_exec]
  // Generate a diagram based on a graphviz DOT diagram description.
  const createDiagram = dot => {
    if (!dot) {
      throw new Error('syntax: no graphviz definition provided');
    }

    // Adds a watermark to the dot graphic.
    const dotFlags = [
      '-Glabel="Made on Cloud Run"',
      '-Gfontsize=10',
      '-Glabeljust=right',
      '-Glabelloc=bottom',
      '-Gfontcolor=gray',
    ].join(' ');

    const image = execSync(`/usr/bin/dot ${dotFlags} -Tpng`, {
      input: dot,
    });
    return image;
  };
  // [END cloudrun_system_package_exec]

  module.exports = app;

  ```

  Artifact Registry ã‚’ä½œæˆã™ã‚‹ã€‚

  ```bash
  gcloud artifacts repositories create cloud-run-source-deploy --repository-format docker --location us-central1
  ```

  ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€ Artifact Registryã«ç™»éŒ²ã™ã‚‹ã€‚

  ```bash
  gcloud builds submit --tag us-central1-docker.pkg.dev/lyrical-art-273306/cloud-run-source-deploy/graphviz
  ```

  ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã‚Œã°OK!

  ```bash
  SUCCESS
  ```

  ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚‚ç¢ºèªãŒå–ã‚Œã¾ã—ãŸï¼

  ![](/images/927e99dc0bf450/2.png)

  ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚

  ```bash
  gcloud iam service-accounts create sampleGcloudAccount
  ```

  ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚

  ```bash
  gcloud run deploy graphviz-web --service-account sampleGcloudAccount@lyrical-art-273306.iam.gserviceaccount.com  --image us-central1-docker.pkg.dev/lyrical-art-273306/cloud-run-source-deploy/graphviz
  ```

  ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã‚Œã°OK!!

  ```bash
  Done.                                                                                                                                                                                         
  Service [graphviz-web] revision [graphviz-web-00002-nl5] has been deployed and is serving 100 percent of traffic.
  Service URL: https://graphviz-web-429380797965.us-east1.run.app
  ```

  ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚‚ç¢ºèªã—ã¦ã¿ã¾ã™ï¼

  ![](/images/927e99dc0bf450/3.png)

  ä»¥ä¸‹ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸæ©Ÿèƒ½ã‚’è©¦ã›ã¾ã™ã€‚

  ```bash
  https://graphviz-web-429380797965.us-east1.run.app/diagram.png?dot=digraph Run { rankdir=LR Code -> Build -> Deploy -> Run }
  ```

  ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ï¼ï¼

  ![](/images/927e99dc0bf450/diagram.png)

  ã‚ã£ã¡ã‚ƒç°¡å˜ã§ã³ã£ãã‚Šã—ã¾ã—ãŸï¼ï¼

  Fargateã‚ˆã‚Šã‚‚ä½¿ã„å‹æ‰‹ãŒè‰¯ã•ãã†ï¼ï¼

- **ã‚¸ãƒ§ãƒ–ã‚’å‹•ã‹ã—ã¦ã¿ãŸ**

  æœ€å¾Œã«ã‚¸ãƒ§ãƒ–ã¨ã—ã¦å‹•ã‹ã—ã¦ã¿ã¾ã—ãŸï¼ï¼

  åŸºæœ¬ã¯ã“ã‚Œã¾ã§ã¨åŒã˜ã§ã™ã€‚

  ã¡ã‚‡ã£ã¨ç•°ãªã‚‹ã®ã¯ **ã‚¿ã‚¹ã‚¯** ãªã©ã®æ¦‚å¿µãŒå‡ºã¦ãã‚‹ã¨ã“ã‚ã§ã™ã‹ã­ã€‚

  - **Cloud Run ã‚¸ãƒ§ãƒ–**

    Cloud Run ã‚¸ãƒ§ãƒ–ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€å®Ÿè¡Œã™ã‚¿ã‚¹ã‚¯ã®æ•°ã‚’æŒ‡å®šã§ãã¾ã™ã€‚
  
    çµ„ã¿è¾¼ã¿ã®ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ CLOUD_RUN_TASK_INDEX ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚‹ã‚‰ã—ãã€ä»Šå›ã¯ã“ã‚Œã‚’åˆ©ç”¨ã—ã¾ã™ã€‚  
    
    ã“ã‚Œã¯ã€å„ã‚¿ã‚¹ã‚¯ãŒã‚³ãƒ³ãƒ†ãƒŠã® 1 ã¤ã®å®Ÿè¡Œä¸­ã®ã‚³ãƒ”ãƒ¼ã‚’è¡¨ã—ã¾ã™ã€‚ã‚¿ã‚¹ã‚¯ã¯é€šå¸¸ã€ä¸¦è¡Œã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚å„ã‚¿ã‚¹ã‚¯ãŒç‹¬ç«‹ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ–ã‚»ãƒƒãƒˆã‚’å‡¦ç†ã§ãã‚‹å ´åˆã¯ã€è¤‡æ•°ã®ã‚¿ã‚¹ã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã¨ä¾¿åˆ©ã§ã™ã€‚

    å„ã‚¿ã‚¹ã‚¯ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’èªè­˜ã—ã€CLOUD_RUN_TASK_INDEX ç’°å¢ƒå¤‰æ•°ã«æ ¼ç´ã•ã‚Œã¾ã™ã€‚ãã—ã¦çµ„ã¿è¾¼ã¿ã® CLOUD_RUN_TASK_COUNT ç’°å¢ƒå¤‰æ•°ã«ã¯ã€ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œæ™‚ã« --tasks ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»‹ã—ã¦æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã®æ•°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

    ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€çµ„ã¿è¾¼ã¿ã® CLOUD_RUN_TASK_ATTEMPT ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ã‚¿ã‚¹ã‚¯ã‚’å†è©¦è¡Œã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã®å¤‰æ•°ã¯ã‚¿ã‚¹ã‚¯ã®å†è©¦è¡Œå›æ•°ã‚’è¡¨ã—ã¾ã™ã€‚æœ€åˆã®å†è©¦è¡ŒãŒè¡Œã‚ã‚Œã‚‹ã¨ã€ã“ã®å¤‰æ•°ã« 0 ãŒè¨­å®šã•ã‚Œã€--max-retries ã«ãªã‚‹ã¾ã§å†è©¦è¡Œã®ãŸã³ã«å€¤ãŒ 1 ãšã¤å¢—åŠ ã—ã¾ã™ã€‚
  
  - **Procfile**

    ã‚‚ã†ä¸€ã¤ **Procfile** ã¨ã„ã†ã‚‚ã®ã‚‚ç™»å ´ã—ã¾ã™ï¼

    Procfileã¯Herokuã¸ã®Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãŠãªã˜ã¿ã®æ–¹ã‚‚ãŠã‚‰ã‚Œã‚‹ã‹ã¨æ€ã„ã¾ã™ãŒã€Foremanã‚„honchoã§ã‚‚ä½¿ç”¨ã•ã‚Œã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ã§ã™ã€‚Dockerfileã®ã‚ˆã†ã«æ‹¡å¼µå­ã¯ãªãProcfileã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

    ä»Šå›ã ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã§ã™ã€‚

    ```yaml
    # Define the application's entrypoint to override default, `npm start`
    # https://github.com/GoogleCloudPlatform/buildpacks/issues/160
    web: node index.js
    ```

  ä»Šå›å‹•ã‹ã™`index.js`ã®ä¸­èº«ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

  ```js 
  // Retrieve Job-defined env vars
  const {
    CLOUD_RUN_TASK_INDEX = 0, 
    CLOUD_RUN_TASK_ATTEMPT = 0
  } = process.env;
  // Retrieve User-defined env vars
  const {SLEEP_MS, FAIL_RATE} = process.env;

  /**
  * ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
  */
  const main = async () => {
    console.log(
      `Starting Task #${CLOUD_RUN_TASK_INDEX}, Attempt #${CLOUD_RUN_TASK_ATTEMPT}...`
    );
    // Simulate work
    if (SLEEP_MS) {
      await sleep(SLEEP_MS);
    }
    // Simulate errors
    if (FAIL_RATE) {
      try {
        randomFailure(FAIL_RATE);
      } catch (err) {
        err.message = `Task #${CLOUD_RUN_TASK_INDEX}, Attempt #${CLOUD_RUN_TASK_ATTEMPT} failed.\n\n${err.message}`;
        throw err;
      }
    }
    console.log(`Completed Task #${CLOUD_RUN_TASK_INDEX}.`);
  };

  // Wait for a specific amount of time
  const sleep = ms => {
    return new Promise(resolve => setTimeout(resolve, ms));
  };

  // Throw an error based on fail rate
  const randomFailure = rate => {
    rate = parseFloat(rate);
    if (!rate || rate < 0 || rate > 1) {
      console.warn(
        `Invalid FAIL_RATE env var value: ${rate}. Must be a float between 0 and 1 inclusive.`
      );
      return;
    }

    const randomFailure = Math.random();
    if (randomFailure < rate) {
      throw new Error('Task failed.');
    }
  };

  // Start script
  main().catch(err => {
    console.error(err);
    process.exit(1); // Retry Job Task by exiting the process
  });
  ```

  ã¾ãšã€Artifact Registryã«ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™ï¼ï¼

  ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹éš›ã«ã‚¿ã‚¹ã‚¯æ•°ãªã©ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦æ¸¡ã—ã¦ã„ã¾ã™ï¼

  ```bash
  gcloud run jobs deploy job-quickstart \
    --source . \
    --tasks 50 \
    --set-env-vars SLEEP_MS=10000 \
    --set-env-vars FAIL_RATE=0.1 \
    --max-retries 5 \
    --region us-east1 \
    --project=lyrical-art-273306
  ```

  ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ï¼

  ![](/images/927e99dc0bf450/4.png)

  ç„¡äº‹ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¦ã„ã‚‹ã‚ˆã†ã§ã™ï¼

  ã§ã¯ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ï¼ï¼

  ```bash
  gcloud run jobs execute job-quickstart --region us-east1
  ```
  

  ```bash
  âœ“ Creating execution... Done.    

  Done.                            
    Execution [job-quickstart-g8ng5] has successfully started running.

    View details about this execution by running:
    gcloud run jobs executions describe job-quickstart-g8ng5

    Or visit https://console.cloud.google.com/run/jobs/executions/details/us-east1/job-quickstart-g8ng5/tasks
  ```

  ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ç§»å‹•ã—ã¦ã¿ã‚‹ã¨ï¼ï¼

  ![](/images/927e99dc0bf450/5.png)

  ã¡ã‚ƒã‚“ã¨50ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã•ã‚Œã¦ã„ãã†ã§ã™ã­ï¼ï¼

  ã‚ã£ã¡ã‚ƒç°¡å˜ï¼ï¼ï¼

---

## ã¾ã¨ã‚

ã„ã‹ãŒã§ã—ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ

Cloud Runã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã—ã¦ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã§å®Ÿè¡Œã™ã‚‹ãŸã‚ã®å¼·åŠ›ãªãƒ„ãƒ¼ãƒ«ã§ã—ãŸï¼ï¼

ä»Šå›ã®å…¥é–€è¨˜äº‹ã§ã¯ã€Cloud Runã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã¨ãƒ¡ãƒªãƒƒãƒˆã‚’ç´¹ä»‹ã—ã¾ã—ãŸãŒã€ã‚‚ã£ã¨å¤šãã®ã‚µãƒ³ãƒ—ãƒ«ã‚„ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—ã«ãƒˆãƒ©ã‚¤ã—ã¦ã¿ã¦é«˜åº¦ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã§ãã‚‹ã‚ˆã†ã«ãªã‚ŠãŸã„ãªã¨æ€ã„ã¾ã—ãŸï¼ï¼

**AWS** ã‚‚ **Google Cloud** ã‚‚æœ€åˆã¯ã‚ˆãåˆ†ã‹ã‚“ãªã‹ã£ãŸã§ã™ãŒã€å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ãªã‚‹ã¨ã“ã‚ŒãŒéå¸¸ã«æ¥½ã—ã„ï¼ï¼

**ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹** ã¯æœ€é«˜ã ï¼ï¼

ã“ã“ã¾ã§èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼

### å‚è€ƒæ–‡çŒ®

1. [Google Cloud ã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.cloud.google.com/)
2. [Qita - Google Cloud Run ã‚’ä½¿ã†ã¾ã§](https://qiita.com/massie_g/items/5a9ce514eaa7c460b5e3)
3. [Cloud Run ã‚’æœ€é€Ÿã§è§¦ã£ã¦ã¿ã‚‹](https://medium.com/google-cloud-jp/cloud-run-%E3%82%92%E6%9C%80%E9%80%9F%E3%81%A7%E8%A7%A6%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B-6e42021307d4)
4. [Cloud Runã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/run/docs?hl=ja)
5. [Cloud Run ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ](https://cloud.google.com/run/docs/quickstarts/deploy-container?hl=ja)
6. [Cloud Run ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢](https://console.cloud.google.com/run?hl=ja&project=lyrical-art-273306)
7. [Cloud Run Node.js ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ](https://cloud.google.com/run/docs/quickstarts/build-and-deploy/deploy-nodejs-service?hl=ja)
8. [Cloud CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †](https://cloud.google.com/sdk/docs/install?hl=JA)
9. [Cloud Run - å®Ÿè¡Œç’°å¢ƒ](https://cloud.google.com/run/docs/about-execution-environments?hl=ja)
10. [ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã£ã¦Cloud Runã§å‹•ã‹ã™æ–¹æ³•ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://cloud.google.com/run/docs/tutorials/system-packages?hl=ja)
11. [Artifact Registry ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢](https://console.cloud.google.com/artifacts/browse/lyrical-art-273306?hl=ja&project=lyrical-art-273306)
12. [Cloud Run ã§ã® Node.js ã‚¸ãƒ§ãƒ–ã®ãƒ“ãƒ«ãƒ‰ã¨ä½œæˆ](https://cloud.google.com/run/docs/quickstarts/jobs/build-create-nodejs?hl=ja)
13. [GitHub - GoogleCloudPlatform/cloud-run-samples](https://github.com/GoogleCloudPlatform/cloud-run-samples)
14. [Zenn - Cloud Run ã‚¸ãƒ§ãƒ– ã“ã¨ã¯ã˜ã‚](https://zenn.dev/google_cloud_jp/articles/cloudrun-jobs-basic)
15. [GitHub - google-cloud-japan/gcp-getting-started-cloudrun](https://github.com/google-cloud-japan/gcp-getting-started-cloudrun)
16. [FireStore ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://firebase.google.com/docs/firestore?hl=ja)
17. [Firebase CLI ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://firebase.google.com/docs/cli?hl=ja)